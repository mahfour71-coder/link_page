<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ù‚Ø±Ø§Ø¡Ø© Excel ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØµÙˆØµ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>

  <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„ØµÙˆØ± (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #e0e7ff, #f4f6f8);
      --bg-secondary: white;
      --text-primary: #1e3a8a;
      --text-success: #15803d;
      --text-error: #dc2626;
      --text-info: #1e40af;
      --border: #e2e8f0;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
      --bg-primary: linear-gradient(135deg, #1e293b, #334155);
      --bg-secondary: #475569;
      --text-primary: #e2e8f0;
      --text-success: #34d399;
      --text-error: #f87171;
      --text-info: #60a5fa;
      --border: #64748b;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg-primary);
      padding: 20px;
      text-align: center;
      direction: rtl;
      margin: 0;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 20px;
    }
    .box {
      background: var(--bg-secondary);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 30px;
      margin: 20px auto;
      width: 95%;
      max-width: 900px;
      transition: transform 0.3s ease;
    }
    .box:hover {
      transform: translateY(-5px);
    }
    input[type="file"], button, input[type="text"], textarea {
      margin: 10px 5px;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      background: var(--bg-secondary);
      color: var(--text-primary);
      box-sizing: border-box;
    }
    input[type="file"] {
      background: #f1f5f9;
    }
    button {
      background-color: var(--text-primary);
      color: white;
      border: none;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #1e40af;
    }
    button:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }
    table {
      border-collapse: collapse;
      margin: 20px auto;
      width: 100%;
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      max-height: 400px;
      overflow-y: auto;
      display: block;
    }
    thead, tbody { display: block; width: 100%; }
    thead { background: var(--text-primary); color: white; }
    tbody { overflow-y: auto; overflow-x: auto; }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: center;
      min-width: 120px;
      display: table-cell;
    }
    th {
      font-weight: 600;
      position: sticky; top: 0;
    }
    td {
      background-color: #f8fafc;
      cursor: pointer;
    }
    td:hover {
      background-color: #e2e8f0;
    }
    .editable {
      background: white;
      border: 1px solid var(--text-primary);
    }
    .preview {
      margin-top: 20px;
      border: 2px dashed var(--border);
      padding: 15px;
      border-radius: 12px;
      background-color: #f8fafc;
      min-height: 100px;
      text-align: right;
    }
    img {
      max-width: 300px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .loading {
      color: var(--text-info);
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    .error { color: var(--text-error); font-weight: bold; }
    .success { color: var(--text-success); font-weight: bold; }
    .log {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
      font-size: 14px;
      text-align: right;
    }
    .search-box {
      width: 100%;
      max-width: 300px;
    }
    .pagination {
      margin: 10px 0;
      text-align: center;
    }
    .pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 14px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--text-primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px; /* RTL */
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .dark-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--text-primary);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1000;
    }
    @media (max-width: 768px) {
      .box { width: 100%; padding: 20px; }
      table { font-size: 14px; }
      th, td { padding: 5px; min-width: 80px; }
      .pagination button { padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <button class="dark-toggle" onclick="toggleDarkMode()" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">ğŸŒ™</button>
  <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù‚Ø±Ø§Ø¡Ø© Excel ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØµÙˆØµ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h1>

  <div class="box">
    <h3>ğŸ“ Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel</h3>
    <input type="file" id="excelInput" accept=".xlsx,.xls" aria-label="Ø±ÙØ¹ Ù…Ù„Ù Excel" />
    <p id="excelStatus">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø¹Ø¯</p>
    <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„..." onkeyup="searchTable()" />
    <div>
      <button onclick="exportToExcel()">ØªØµØ¯ÙŠØ± ÙƒÙ€ Excel</button>
      <button onclick="exportToCSV()">ØªØµØ¯ÙŠØ± ÙƒÙ€ CSV</button>
      <button onclick="printTable()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
      <button onclick="addNewRow()">Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</button>
      <button onclick="clearData()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
    <div class="pagination" id="pagination"></div>
    <table id="excelTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <hr />

    <h3>ğŸ–¼ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ (OCR)</h3>
    <input type="file" id="imageInput" accept="image/*" aria-label="Ø±ÙØ¹ ØµÙˆØ±Ø©" />
    <div class="preview" id="imagePreview">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</div>
    <p id="ocrStatus"></p>
    <div class="preview" id="textPreview">
      <textarea id="editableText" rows="5" style="width: 100%; display: none;" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù‡Ù†Ø§... ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©" aria-label="ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†Øµ"></textarea>
    </div>
    <button id="confirmText" style="display: none;" onclick="addTextToTable()">ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ</button>
    <div id="log" class="log"></div>
  </div>

  <script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const excelInput = document.getElementById("excelInput");
    const excelTable = document.getElementById("excelTable");
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    const excelStatus = document.getElementById("excelStatus");
    const searchInput = document.getElementById("searchInput");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const ocrStatus = document.getElementById("ocrStatus");
    const textPreview = document.getElementById("textPreview");
    const editableText = document.getElementById("editableText");
    const confirmTextBtn = document.getElementById("confirmText");
    const logDiv = document.getElementById("log");
    const paginationDiv = document.getElementById("pagination");
    let excelData = [];
    let extractedText = null;
    let currentPage = 1;
    const rowsPerPage = 10;
    let allHeaders = [];
    const maxRows = 1000; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø¯Ø§Ø¡

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('excelData');
        if (saved) {
          excelData = JSON.parse(saved);
          if (excelData.length > 0) {
            allHeaders = excelData[0];
            displayTable(excelData);
            addToLog("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†", "success");
          }
        }
      } catch (err) {
        addToLog("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message, "error");
      }
    }

    // Ø­ÙØ¸ ÙÙŠ localStorage
    function saveToStorage() {
      if (excelData.length > maxRows) {
        addToLog("ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­ÙØ¸: ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙÙˆÙ", "error");
        return;
      }
      localStorage.setItem('excelData', JSON.stringify(excelData));
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
    function toggleDarkMode() {
      document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ (Ù…Ø¹ debounce)
    let logTimeout;
    function addToLog(message, type = "info") {
      clearTimeout(logTimeout);
      logTimeout = setTimeout(() => {
        const logEntry = document.createElement("p");
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEntry.className = type;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        if (logDiv.children.length > 50) logDiv.removeChild(logDiv.firstChild); // Ø­Ø¯ Ù„Ù„Ù€ logs
      }, 100);
    }

    // ÙØ­Øµ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
    window.addEventListener("load", async () => {
      loadFromStorage();
      if (!window.XLSX) {
        addToLog("Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© XLSX Ù„Ù… ØªØªØ­Ù…Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
      } else {
        addToLog("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© XLSX Ø¨Ù†Ø¬Ø§Ø­", "success");
      }
      if (!window.Tesseract) {
        addToLog("Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© Tesseract Ù„Ù… ØªØªØ­Ù…Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
      } else {
        addToLog("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Tesseract Ø¨Ù†Ø¬Ø§Ø­", "success");
      }
    });

    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel
    excelInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file || !file.name.match(/\.(xlsx|xls)$/i) || file.size > 10 * 1024 * 1024) {
        excelStatus.textContent = "âš  Ø§Ø®ØªØ± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (Ø£Ù‚Ù„ Ù…Ù† 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)";
        excelStatus.className = "error";
        addToLog("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "error");
        return;
      }

      excelStatus.innerHTML = "ğŸ”„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù <span class='spinner'></span>";
      excelStatus.className = "loading";
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (excelData.length > maxRows) {
            excelData = excelData.slice(0, maxRows);
            addToLog(`ØªÙ… ØªÙ‚ØµÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ${maxRows} ØµÙ`, "info");
          }
          allHeaders = excelData[0] || ['Ø¹Ù…ÙˆØ¯ 1', 'Ø¹Ù…ÙˆØ¯ 2', 'Ø¹Ù…ÙˆØ¯ 3', 'Ø¹Ù…ÙˆØ¯ 4', 'Ø¹Ù…ÙˆØ¯ 5'];
          excelStatus.textContent = `âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù (${excelData.length} ØµÙ)`;
          excelStatus.className = "success";
          addToLog(`ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${excelData.length} ØµÙ Ù…Ù† ${sheetName}`, "success");
          saveToStorage();
          displayTable(excelData);
        } catch (err) {
          excelStatus.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${err.message}`;
          excelStatus.className = "error";
          addToLog(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Excel: ${err.message}`, "error");
        }
      };
      reader.onerror = () => {
        excelStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù";
        excelStatus.className
